--1 GAMER
CREATE OR REPLACE VIEW COMMUNITY_STG.CBC.CBC_DIM_AMEX_MARKETING_GAMER AS
SELECT STG.PROFILE_KEY,STG.AUDT_LOAD_TS,GAMER.RUN_ID
FROM   CBC.PROXY.PUB_CBC_DIM_AMEX_MARKETING_GAMER GAMER
LEFT JOIN "PFL"."PROXY"."PFL_DIM_PROFILE" STG
ON     GAMER.ODS_CUSTOMER_ID = STG.LOYALTY_PROGRAM_ID;


 --2 SMB
 CREATE OR REPLACE VIEW COMMUNITY_STG.CBC.CBC_DIM_AMEX_MARKETING_SMB AS
 SELECT STG.PROFILE_KEY,STG.AUDT_LOAD_TS,SMB.RUN_ID
 FROM   CBC.PROXY.PUB_CBC_DIM_AMEX_MARKETING_SMB SMB
 LEFT JOIN "PFL"."PROXY"."PFL_DIM_PROFILE" STG
 ON     SMB.ODS_CUSTOMER_ID = STG.LOYALTY_PROGRAM_ID;


--3 CAMPAIGN_VIEW
CREATE OR REPLACE VIEW COMMUNITY_STG.CBC.CBC_DIM_AMEX_MARKETING_SPEND_CAMPAIGN_VIEW AS
SELECT STG.PROFILE_KEY,
       CAMP.CELL_CODE AS CELL_CD,
       NULL AS RSVP_CD,
       CASE WHEN UPPER(CAMP.CELL_CODE) IN ('2222EZNA','2222EZN6','2222ENVT','2222ETJ6','2222EKCW','2222F3EU',
                                           '2222F3ET','2222F399','2222EL52','2222F29Y','2222EZN9','2222EZN7')
            THEN 'USBU'
            ELSE 'USCO'
       END AS RPC_CD,
       STG.AUDT_LOAD_TS,
       CAMP.RUN_ID
FROM   CBC.PROXY.PUB_CBC_DIM_AMEX_MARKETING_SPEND_CAMPAIGN CAMP
LEFT JOIN "PFL"."PROXY"."PFL_DIM_PROFILE" STG
 ON     CAMP.ODS_CUSTOMER_ID = STG.LOYALTY_PROGRAM_ID;

--4 GUARDRAIL
CREATE OR REPLACE VIEW COMMUNITY_STG.CBC.CBC_DIM_CUST_GUARDRAIL_FULLSNAP AS
SELECT STG.PROFILE_KEY,
       CASE WHEN UPPER(GUARDRAIL.SUPPRESSION_CD) = 'AMX_CONS_PREM_450' THEN 'USPC'
            WHEN UPPER(GUARDRAIL.SUPPRESSION_CD) = 'AMX_CONS_MID_250' THEN 'USMT'
            WHEN UPPER(GUARDRAIL.SUPPRESSION_CD) = 'AMX_BUS_SBC' THEN 'USBU'
            ELSE GUARDRAIL.SUPPRESSION_CD
       END AS RPC_CD,
       GUARDRAIL.RUN_ID_NUM AS RUN_ID
FROM   (SELECT * FROM "CBC"."PROXY"."PUB_RAILS_CUST_CREDIT_CARD_SUPPRESSION_LOAD"
        WHERE RUN_ID_NUM = (SELECT MAX (RUN_ID_NUM) FROM  "CBC"."PROXY"."PUB_RAILS_CUST_CREDIT_CARD_SUPPRESSION_LOAD" )) GUARDRAIL
LEFT JOIN "PFL"."PROXY"."PFL_DIM_PROFILE" STG
ON GUARDRAIL.ODS_CUSTOMER_ID = STG.LOYALTY_PROGRAM_ID;

--5 AMEX SPEND  ####
CREATE OR REPLACE VIEW COMMUNITY_STG.CBC.CBC_FACT_AMEX_SPEND AS
SELECT TO_DATE(AMEX_SPEND.ASOF_DT,'MON YYYY') AS STATEMENT_DT,
        CASE
            WHEN AMEX_SPEND.PRODUCT_NM_TXT = 'BONVOY BRILLIANT AMEX CARD' THEN 'USPC'
            WHEN AMEX_SPEND.PRODUCT_NM_TXT = 'BONVOY BUSINESS AMEX CARD' THEN 'USBU'
            WHEN AMEX_SPEND.PRODUCT_NM_TXT = 'BONVOY AMEX CARD' THEN 'USCO'
        END AS RPC_CD,
        STG.PROFILE_KEY,
        AMEX_SPEND.TOTAL_CARD_SPEND_AMT,
        AMEX_SPEND.AIRLINE_SPEND_AMT,
        AMEX_SPEND.TRANSPORTATION_RENTAL_SPEND_AMT AS TRANSPORTATION_SPEND_RENTAL_AMT,
        AMEX_SPEND.TRANSPORTATION_OTHER_SPEND_AMT AS TRANSPORTATION_SPEND_OTHER_AMT,
        AMEX_SPEND.DINING_SPEND_AMT,
        AMEX_SPEND.RETAIL_SPEND_AMT,
        AMEX_SPEND.ENTERTAINMENT_SPEND_AMT,
        AMEX_SPEND.MARRIOTT_SPEND_AMT AS MARRIOTT_SPEND_TOTAL_AMT,
        AMEX_SPEND.NON_MARRIOTT_LODGING_SPEND_AMT,
        AMEX_SPEND.DECIMAL AS OTHER_SPEND_AMT,
        AMEX_SPEND.BATCH_DATE_DT AS AUDT_LOAD_TS,
        AMEX_SPEND.RUN_ID_NUM AS RUN_ID
FROM    CBC.PROXY_RESTRICTED.PUB_CBC_FACT_AMEX_SPEND AMEX_SPEND
LEFT JOIN "PFL"."PROXY"."PFL_DIM_PROFILE" STG
ON  AMEX_SPEND.ODS_CUSTOMER_ID = STG.LOYALTY_PROGRAM_ID;
SELECT * FROM CBC.PROXY_RESTRICTED.PUB_CBC_FACT_AMEX_SPEND LIMIT 10;
//##############################//
